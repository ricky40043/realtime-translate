# 開發步驟.md

目標：只做「網頁前端 + 後端」。前端用 **Vue 3**。後端用
**Python(FastAPI)** 或
**Go(Fiber/Gin)**。支援語音→STT→翻譯→多人即時字幕與「主板」統一語言顯示，並可對特定講者覆寫語言。

------------------------------------------------------------------------

## 0. 最小可行功能

-   房間頁：麥克風上傳或純打字。
-   個人視圖：翻成「我的語言」大字字幕。
-   主板視圖：翻成「主板語言」，可 per-speaker 覆寫。
-   STT 與翻譯先用雲端 API。僅文字字幕。

------------------------------------------------------------------------

## 1. 系統組件

-   前端：Vue 3 + Vite + Pinia + Vue Router + WebSocket。
-   後端：
    -   Python：FastAPI + Uvicorn + Redis + PostgreSQL。
    -   Go：Fiber/Gin + Gorilla WebSocket + Redis + PostgreSQL。
-   事件：Redis Pub/Sub（或後端內記憶體廣播）。
-   DB：PostgreSQL（訊息與翻譯版本）。

------------------------------------------------------------------------

## 2. Monorepo 結構

    realtime-translate/
      frontend/           # Vue
      backend/            # Python 或 Go 擇一
      docker/
      docs/
      .env.example
      README.md

------------------------------------------------------------------------

## 3. 資料表（PostgreSQL）

``` sql
create extension if not exists pgcrypto;

create table app_user (
  id uuid primary key default gen_random_uuid(),
  display_name text not null,
  preferred_lang text not null,
  created_at timestamptz not null default now()
);

create table room (
  id uuid primary key default gen_random_uuid(),
  name text not null,
  default_board_lang text not null,
  created_at timestamptz not null default now()
);

create table room_lang_override (
  room_id uuid references room(id) on delete cascade,
  speaker_id uuid references app_user(id) on delete cascade,
  target_lang text not null,
  primary key(room_id, speaker_id)
);

create table message (
  id uuid primary key default gen_random_uuid(),
  room_id uuid references room(id) on delete cascade,
  speaker_id uuid references app_user(id) on delete set null,
  source_lang text,
  text text not null,
  is_final boolean not null default true,
  started_at timestamptz,
  ended_at timestamptz,
  created_at timestamptz not null default now()
);

create table message_translation (
  message_id uuid references message(id) on delete cascade,
  target_lang text not null,
  text text not null,
  latency_ms int,
  quality real,
  primary key(message_id, target_lang)
);
```

------------------------------------------------------------------------

## 4. API 與事件協定

### REST

-   `POST /api/auth/guest` → 匿名登入，回 `{ userId, token }`
-   `POST /api/rooms`（管理）→ 建房
-   `GET /api/rooms/{roomId}` → 房態與語言規則
-   `PUT /api/rooms/{roomId}/board-lang` → 設主板語言
-   `PUT /api/rooms/{roomId}/overrides` → 批次覆寫語言
    `[{speakerId,targetLang}]`
-   `PUT /api/users/{userId}/preferred-lang` → 改個人語言
-   `POST /api/ingest/text` → `{ roomId, text }`（MVP 先從文字）

### WebSocket

-   連線：`/ws?roomId=...&userId=...&token=...`
-   下行：
    -   `personal.subtitle`

        ``` json
        {"type":"personal.subtitle","messageId":"...","targetLang":"zh-TW","text":"..."}
        ```

    -   `board.post`

        ``` json
        {"type":"board.post","messageId":"...","speakerId":"...","targetLang":"en","text":"..."}
        ```

    -   `room.state`（設定更新）
-   上行（可選）：`client.prefLang.update`

------------------------------------------------------------------------

## 5. 處理流程

1.  `ingest/text` 或 STT 最終稿 → 建立 `message`（含 `source_lang`）。
2.  計算目標語言集合：
    -   個人視圖：房內在線者的 `preferred_lang` 去重。
    -   主板視圖：`override[speakerId]` 或 `default_board_lang`。
3.  呼叫翻譯 → 寫 `message_translation`。
4.  廣播：
    -   對每位使用者送 `personal.subtitle`（該使用者語言）。
    -   全房送一次 `board.post`（主板語言或覆寫）。
5.  partial→final：以 `is_final=true` 事件覆蓋。

------------------------------------------------------------------------

## 6. 後端腳手架

### A. Python（FastAPI）

**依賴**

    fastapi uvicorn[standard] redis asyncpg httpx pydantic
    langdetect python-jose[cryptography] python-dotenv

**目錄**

    backend/
      app/
        main.py
        deps.py
        api/
          auth.py
          rooms.py
          ingest.py
        ws/
          hub.py          # 連線管理與廣播
        services/
          translate.py    # 封裝雲翻譯
          lang.py         # 偵測或由 STT 回傳
          router.py       # 語言路由邏輯
        db/
          pool.py
          repo.py

**啟動**

    uvicorn app.main:app --reload --host 0.0.0.0 --port 8081

### B. Go（Fiber/Gin）

**依賴**

    Fiber 或 Gin
    gorilla/websocket
    github.com/redis/go-redis/v9
    github.com/jackc/pgx/v5
    github.com/golang-jwt/jwt/v5

**目錄**

    backend/
      cmd/server/main.go
      internal/
        http/
          router.go
          handlers/
        ws/
          hub.go
          client.go
        svc/
          translate.go
          lang.go
          router.go
        store/
          pg.go
          repo.go

**啟動**

    go run cmd/server/main.go

------------------------------------------------------------------------

## 7. 前端（Vue 3）

**建立**

    npm create vite@latest frontend -- --template vue
    cd frontend
    npm i pinia

**結構**

    src/
      main.ts
      router.ts
      stores/session.ts
      api/http.ts
      views/
        Room.vue
        Settings.vue
      components/
        BigSubtitle.vue
        BoardFeed.vue

**功能** - `Room.vue`：建立 WS 連線，處理事件更新 store。 -
`BigSubtitle.vue`：只顯示我的語言字幕。 -
`BoardFeed.vue`：顯示主板語言卡片流。 -
`Settings.vue`：改個人語言、主板語言、per-speaker 覆寫。

------------------------------------------------------------------------

## 8. 外部服務

-   STT：Google Speech / Azure Speech / OpenAI Realtime（後補）。
-   翻譯：Google Translate / Azure Translator（先選一）。
-   MVP：先做純文字翻譯。

`.env.example`

    POSTGRES_URL=postgres://user:pass@db:5432/rt
    REDIS_URL=redis://redis:6379
    JWT_SECRET=change_me
    TRANSLATE_PROVIDER=google
    GOOGLE_API_KEY=xxx
    AZURE_TRANSLATOR_KEY=
    AZURE_TRANSLATOR_ENDPOINT=

------------------------------------------------------------------------

## 9. Docker

`docker-compose.yml`（簡化）

``` yaml
services:
  db:
    image: postgres:16
    environment:
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: rt
    ports: ["5432:5432"]
  redis:
    image: redis:7
    ports: ["6379:6379"]
  backend:
    build: ./backend
    env_file: .env
    depends_on: [db, redis]
    ports: ["8081:8081"]
  frontend:
    build: ./frontend
    ports: ["5173:5173"]
```

------------------------------------------------------------------------

## 10. 測試

-   單元：語言路由、翻譯聚合、JWT 驗證。
-   合約：REST 與 WS 事件格式。
-   E2E：兩瀏覽器同房，一人發文，驗證個人視圖與主板視圖。
-   負載：10 人房，每秒 2 訊息，延遲 \< 2s。

------------------------------------------------------------------------

## 11. 權限與隱私

-   入房提示「即時轉譯與記錄」。
-   提供「不保存」模式（只 Redis 暫存）。
-   管理者可清空房內訊息。

------------------------------------------------------------------------

## 12. 延遲與成本

-   成本主要來自 STT。文字模式最低。
-   延遲目標 1--2 秒。

------------------------------------------------------------------------

## 13. AI 任務分解（直接貼給 AI）

**後端（Python FastAPI）** 1. 建立 `/api/auth/guest`：產匿名使用者與
JWT。 2. 建立 Rooms CRUD、`PUT /board-lang`、`PUT /overrides`。 3. 建立
`/api/ingest/text`：寫 `message` → 依語言集合呼叫 `translate()` → 廣播
`personal.subtitle` 與 `board.post`。 4. 實作 `/ws`：驗證 token，加入
room，維護連線與定向廣播。 5. `services/translate.py`：封裝 Google/Azure
翻譯。 6. 寫 repo 與 migration，對照本檔 schema。

**後端（Go）** 1. 用 Fiber/Gin 與 Gorilla WS 寫 hub，支援 room/user
定向廣播。 2. 用 pgx 與 go-redis 完成儲存與 Pub/Sub。 3. 封裝
`Translate(text, targetLang)`，用 `net/http` 調雲端翻譯。 4. 完成
`/api/ingest/text` 與語言路由。

**前端（Vue）** 1. 寫 `Room.vue`：連線 WS，處理
`personal.subtitle`、`board.post`。 2. 寫
`BigSubtitle.vue`、`BoardFeed.vue` UI。 3. 寫 `Settings.vue`：修改
`preferred_lang`、主板語言與覆寫。

------------------------------------------------------------------------

## 14. 里程碑

-   M1：後端與前端骨架＋DB schema。
-   M2：`ingest/text`→翻譯→廣播打通。
-   M3：大字字幕與主板 UI。
-   M4：設定頁與覆寫。
-   M5：Docker 化與基本壓測。

------------------------------------------------------------------------

## 15. 驗收

-   兩瀏覽器同房。A 輸入中文，B
    的個人視圖顯示英文，主板顯示日文（若覆寫）。延遲 \< 2s。
-   切換個人與主板語言，下一則訊息即生效。
-   重整後可載入歷史訊息與翻譯版本。
